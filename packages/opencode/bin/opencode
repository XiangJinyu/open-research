#!/usr/bin/env bash
set -euo pipefail

SCRIPT_PATH="$(readlink -f "$0" 2>/dev/null || python3 -c "import os,sys; print(os.path.realpath(sys.argv[1]))" "$0")"
SCRIPT_DIR="$(dirname "$SCRIPT_PATH")"

if [ -n "${OPENCODE_BIN_PATH:-}" ]; then
  exec "$OPENCODE_BIN_PATH" "$@"
fi

# Cached binary (symlink to compiled output)
CACHED="$SCRIPT_DIR/.opencode"
if [ -x "$CACHED" ]; then
  exec "$CACHED" "$@"
fi

# Look for compiled binary in dist/
DIST_DIR="$(dirname "$SCRIPT_DIR")/dist"
PLATFORM="$(uname -s | tr '[:upper:]' '[:lower:]')"
ARCH="$(uname -m)"
case "$ARCH" in
  x86_64) ARCH="x64" ;;
  aarch64) ARCH="arm64" ;;
esac

BINARY="$DIST_DIR/openresearch-${PLATFORM}-${ARCH}/bin/opencode"
if [ -x "$BINARY" ]; then
  exec "$BINARY" "$@"
fi

echo "Could not find openresearch binary. Try running: cd packages/opencode && bun run build --single --skip-install" >&2
exit 1
